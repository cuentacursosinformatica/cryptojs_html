<!DOCTYPE html>
<html>
<head>
<title>Cifrar con CryptoJS + PBKDF2</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
* { box-sizing: border-box; }
body { font-family:verdana; font-size:14px; }
h1 { border-bottom: solid 1px red; border-color:grey; }

div { margin-top:0px; width:90%; margin-left:16px; }
label { width:250px; margin-bottom:1px; display:block; }
input { width:100%; margin-top:4px; margin-bottom:8px; }
button { height:25px; margin-bottom:6px; }
.boton_grande { width:100%; }
textarea { width:100%; margin-top:4px; margin-bottom:4px; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
function copiarTextoCifrado(){
    const mensaje_cifrado = document.getElementById("mensaje_cifrado").value;
    if (mensaje_cifrado !== "") {
        navigator.clipboard.writeText(mensaje_cifrado)
            .then(() => { console.log("Salida copiada."); })
            .catch(err => { console.log("Error al copiar: ", err); });
    }
}

function cifrar(){
    const password = document.getElementById("tu_password").value;
    const mensaje = document.getElementById("mensaje_cifrar").value;
    if(!password || !mensaje) return alert("Escribe contraseña y mensaje.");

    // Generar salt y derivar clave con PBKDF2
    const salt = CryptoJS.lib.WordArray.random(128/8); // 16 bytes
    const key = CryptoJS.PBKDF2(password, salt, { keySize: 256/32, iterations: 100000, hasher: CryptoJS.algo.SHA256 });

    // Generar IV aleatorio
    const iv = CryptoJS.lib.WordArray.random(128/8);

    // Cifrar con AES-CBC
    const encrypted = CryptoJS.AES.encrypt(mensaje, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });

    // Combinar salt + iv + ciphertext en Base64 para guardar todo
    const paquete = salt.toString() + iv.toString() + encrypted.ciphertext.toString();
    document.getElementById("mensaje_cifrado").value = paquete;
}

function descifrar(){
    const password = document.getElementById("tu_password").value;
    const paquete = document.getElementById("mensaje_cifrado").value;
    if(!password || !paquete) return alert("Escribe contraseña y mensaje cifrado.");

    try {
        // Extraer salt, iv y ciphertext
        const salt = CryptoJS.enc.Hex.parse(paquete.substr(0,32)); // 16 bytes = 32 hex
        const iv = CryptoJS.enc.Hex.parse(paquete.substr(32,32));  // 16 bytes = 32 hex
        const ciphertext = CryptoJS.enc.Hex.parse(paquete.substr(64));

        // Derivar clave con PBKDF2
        const key = CryptoJS.PBKDF2(password, salt, { keySize: 256/32, iterations: 100000, hasher: CryptoJS.algo.SHA256 });

        // Descifrar
        const decrypted = CryptoJS.AES.decrypt({ciphertext: ciphertext}, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
        const mensajeOriginal = decrypted.toString(CryptoJS.enc.Utf8);

        document.getElementById("mensaje_cifrado").value = mensajeOriginal;
    } catch(e){
        alert("Error al descifrar. Contraseña incorrecta o mensaje corrupto.");
        console.log(e);
    }
}
</script>
</head>
<body>
<h1>Cifrar AES CryptoJS + PBKDF2</h1>
<p>Instrucciones:</p>
<ol>
<li>Escribe una contraseña</li>
<li>Teclea tu mensaje de entrada</li>
<li>Pulsa el botón para cifrar o descifrar</li>
</ol>
<hr><br>
<div>
<label for="tu_password">Contraseña:</label>
<input type="text" name="contraseña" id="tu_password" placeholder="escribe tu contraseña" >
</div>
<div>
<label for="mensaje_cifrar">Mensaje entrada:</label>
<input type="text" name="mensaje" id="mensaje_cifrar" placeholder="escribe tu mensaje para cifrar" >
</div>
<br>
<div>
<button type="button" class="boton_grande" onclick="cifrar()">CIFRAR</button>    
</div>
<div>
<button type="button" class="boton_grande" onclick="descifrar()">DESCIFRAR</button>
</div>
<br>
<div>
<label for="mensaje_cifrado">Mensaje salida:</label>
<textarea rows="6" type="text" name="mensaje_cifrado" id="mensaje_cifrado" placeholder="Aquí aparece el mensaje cifrado o descifrado" ></textarea>
</div>
<div>
<button type="button" class="boton_grande" onclick="copiarTextoCifrado()">COPIAR SALIDA</button>
</div>
</body>
</html>
